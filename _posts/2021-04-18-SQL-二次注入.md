---
title: SQL-二次注入
categories:
 - SQL
tags:
- SQL

---

复习的时候发现之前看二次注入忘记做总结了，有些细节记得不是特别清楚，在这篇博客里对二次注入的一些要点做个梳理。

# 原理

第一次进行数据库插入数据的时候，仅仅只是使用了addslashes或者是借助get_magic_quotes_gpc对其中的特殊字符进行了转义，在写入数据库的时候还是保留了原来的数据，但是数据本身还是脏数据。 在将数据存入到了数据库中之后，开发者就认为数据是可信的。在下一次进行需要进行查询的时候，直接从数据库中取出了脏数据，没有进行进一步的检验和处理，这样就会造成SQL的二次注入。

![由“强网杯”的three hit聊聊二次注入](https://image.3001.net/images/20180331/15224810526050.png!small)

## php常见转义函数

### addslashes

addslashes() 函数返回在预定义字符之前添加反斜杠的字符串。

预定义字符是：

- 单引号（'）
- 双引号（"）
- 反斜杠（\）
- NULL

**提示：**该函数可用于为存储在数据库中的字符串以及数据库查询语句准备字符串。

**注释：**默认地，PHP 对所有的 GET、POST 和 COOKIE 数据自动运行 addslashes()。所以您不应对已转义过的字符串使用 addslashes()，因为这样会导致双层转义。遇到这种情况时可以使用函数 get_magic_quotes_gpc() 进行检测。

### mysql_real_escape_string

mysql_real_escape_string() 函数转义 SQL 语句中使用的字符串中的特殊字符。

下列字符受影响：

- \x00
- \n
- \r
- \
- '
- "
- \x1a

如果成功，则该函数返回被转义的字符串。如果失败，则返回 false。

## 数据库特性

上面提到在写入数据库的时候还是保留了原来的数据，这点可以做个小测试

![image-20210418164105735](https://raw.githubusercontent.com/MercyL1n/blog-picture/main/img%5Cimage-20210418164105735.png)

我们插入值的时候是已经转义的，但是储存的数据却是原数据。

本来是打算在找几个实例来分析一下实际场景中的二次注入，不过找到的几个感觉都太简单没什么值得进一步分析的，就有一个利用宽字节来进行注入的挺有意思，结合了宽字节注入的原理，来构造出一个`'`,然后在取出数据时完成二次注入。之后在学习工作中遇到了二次注入的例子会再写一篇文章来好好记录下。

# 防御

二次注入发生时，虽然会对用户的输入的一些符号进行转义，但是在存入数据库的时候被还原，如果从数据库中取数据的时候直接进行利用，就会造成二次注入，因此在从数据库或文件中取数据的时候，也要进行转义或者过滤。

# 参考

[1] [由Three Hit聊聊二次注入](https://www.freebuf.com/articles/web/167089.html)